name: 'E2E'

on:
  schedule:
    - cron: "10 4 * * 4"
  workflow_dispatch:

jobs:
  tests:
    name: Run E2E Tests
    runs-on: macos-latest

    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
      KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
      BASIC_AUTH_USER: ${{ secrets.BASIC_AUTH_USER }}
      BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Run instrumented tests in app module
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          script: |
            ./gradlew connectedTstDebugAndroidTest || true

            echo "Pulling screenshots..."
            adb pull /storage/emulated/0/googletest/test_outputfiles ./screenshots || true

            echo "Dumping logcat..."
            adb logcat -d > logcat.txt || true
          heap-size: 1024M
          memory: 2G
          cores: 2
          disable-animations: true

      - name: Upload screenshots artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: ./screenshots

      - name: Upload logcat
        uses: actions/upload-artifact@v4
        with:
          name: logcat
          path: logcat.txt
